---

# 使用ESP32和RC522 RFID讀取器實現卡片偵測與光線感測自動更新API說明書



## 目錄
1. [簡介](#簡介)
2. [功能說明](#功能說明)
3. [硬體需求](#硬體需求)
4. [接線圖](#接線圖)
5. [程式元件簡介](#程式元件簡介)
6. [使用步驟](#使用步驟)
7. [常見問題排解](#常見問題排解)

---

## 簡介
本程式使用 ESP32 搭配 RC522 RFID 模組與光線感測器，實現以下功能：
- 讀取 RFID 卡片的 UID 並上傳至指定伺服器。
- 檢測環境光線變化並更新其狀態。
- 支援 JSON 格式的 PUT 請求以同步設備狀態。

---

## 功能說明
1. **WiFi 連接**  
   ESP32 通過指定的 SSID 和密碼連接 WiFi，並與 API 伺服器通訊。

2. **RFID 卡片讀取**  
   使用 RC522 RFID 模組讀取卡片的 UID，並透過伺服器更新卡片的狀態。

3. **光線感測**  
   利用光線感測器檢測環境光線變化，決定 RC522 RFID 的工作狀態。

4. **狀態更新**  
   當檢測到卡片或光線變化時，向 API 發送 JSON 格式的 PUT 請求更新狀態。

---

## 硬體需求
- **ESP32 開發板**
- **RC522 RFID 模組**
- **光線感測器 (接類比輸入)**
- **跳線若干**

---

## 接線圖
| 元件              | ESP32 引腳 |
|-------------------|------------|
| RC522 SDA (SS)    | GPIO 5     |
| RC522 RST         | GPIO 0     |
| RC522 SCK         | GPIO 18    |
| RC522 MOSI        | GPIO 23    |
| RC522 MISO        | GPIO 19    |
| 光線感測器輸出    | GPIO 34    |

---

## 程式元件簡介

### 1. WiFi 連接設定
```cpp
const char* ssid = "UR_SSID";
const char* password = "UR_PASSWORD";
```
設定 WiFi 的 SSID 和密碼。若連接失敗，ESP32 會重新啟動。

---

### 2. RFID 初始化與重置
```cpp
MFRC522 rfid(SDA_PIN, RST_PIN);
void resetRFIDReader() { ... }
```
初始化 RFID RC522 模組，並設定天線增益以提升靈敏度。

---

### 3. 光線感測與防抖處理
```cpp
bool getDebouncedLightState(int lightValue) { ... }
```
光線感測器使用類比讀取，透過多次採樣進行平均值計算，減少雜訊干擾。

---

### 4. JSON 請求更新
```cpp
void updateJsonAndSendPutRequest(String cardUID, int lightValue) { ... }
```
將卡片 UID 和光線狀態打包為 JSON 格式，並發送至 API URL。

---

### 5. 系統狀態輸出
```cpp
void printSystemStatus(int lightValue) { ... }
```
每秒列印當前系統狀態，包含光線數值、卡片狀態、RFID 狀態及目前 UID。

---

## 使用步驟

1. **硬體接線**  
   確保 RFID 模組與光線感測器依據[接線圖](#接線圖)正確連接到 ESP32。

2. **編譯與上傳**  
   - 使用 Arduino IDE 或其他 ESP32 編譯器。
   - 將程式碼上傳至 ESP32 開發板。

3. **監控序列埠**  
   開啟序列監視器以檢視系統狀態及錯誤資訊。

4. **測試功能**  
   - 在 RFID 偵測範圍內放置卡片，檢查是否正確讀取 UID。
   - 調整光線感測器環境，觀察狀態變化。

---

## 常見問題排解

### 問題 1: WiFi 無法連接
- 確認 SSID 和密碼是否正確。
- 測試 ESP32 是否靠近路由器。

### 問題 2: RFID 卡片無法讀取
- 確保 RC522 模組接線正確。
- 測試卡片是否損壞。

### 問題 3: 光線感測異常
- 確認感測器的供電是否穩定。
- 調整光線閾值以匹配環境光強。

---
